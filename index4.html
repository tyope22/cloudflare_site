<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In-Browser PDF Optimizer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load pdf-lib for PDF manipulation -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #4F46E5;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8">

    <div id="root" class="w-full max-w-5xl mx-auto">
        <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">PDF Compression & Cropping Tool</h1>
        <p class="text-gray-600 mb-8">Reduce file size and crop pages entirely in your browser. (Requires a modern browser and the original PDF is not uploaded anywhere.)</p>

        <!-- Status Message -->
        <div id="status-box" class="bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-4 rounded-lg mb-6 shadow">
            <p id="status-text" class="font-medium">Ready: Upload a PDF file to begin optimization.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- File Upload & Information -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-xl h-full flex flex-col justify-start">
                <label for="fileInput" class="block text-lg font-medium text-gray-800 mb-3">1. Upload Source PDF</label>
                <input 
                    type="file" 
                    id="fileInput" 
                    accept="application/pdf" 
                    class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 p-2.5 hover:bg-gray-100 flex-grow"
                />
                <div id="pdfInfo" class="mt-4 text-sm text-gray-600 space-y-1">
                    <p>File: <span id="fileName" class="font-medium">N/A</span></p>
                    <p>Pages: <span id="pageCount" class="font-medium">N/A</span></p>
                    <p>Original Size: <span id="fileSize" class="font-medium">N/A</span></p>
                    <p>New Size: <span id="newFileSize" class="font-medium text-green-700">N/A</span></p>
                </div>
            </div>

            <!-- Size Reduction (Compression) Controls -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-full">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">2. File Size Reduction (Compression)</h3>
                    <div class="space-y-4">
                        
                        <!-- Target Size Input -->
                        <div class="mb-4">
                            <label for="targetSize" class="block text-sm font-medium text-gray-700">Target Max Size (KB)</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input
                                    type="number"
                                    id="targetSize"
                                    value="200"
                                    min="1"
                                    class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                                />
                                <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                                    KB
                                </span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Goal for the final file size.</p>
                        </div>

                        <!-- NEW: Optimization Priority -->
                        <h4 class="text-sm font-medium text-gray-700 pt-2 border-t pt-4">Optimization Priority:</h4>
                        <div id="prioritySelector" class="grid grid-cols-2 gap-2">
                             <button
                                data-priority="quality"
                                class="px-3 py-2 rounded-lg font-semibold text-sm transition duration-150 w-full border-2 bg-indigo-600 text-white shadow-md border-indigo-700"
                            >
                                Quality
                            </button>
                            <button
                                data-priority="size"
                                class="px-3 py-2 rounded-lg font-semibold text-sm transition duration-150 w-full border-2 bg-gray-200 text-gray-700 hover:bg-gray-300 border-gray-200"
                            >
                                Size (Override)
                            </button>
                        </div>
                        <p id="priorityTip" class="text-xs text-gray-500 mt-2 italic">Prioritizing size applies maximum compression, which may reduce image quality but gives the best chance of hitting your KB target.</p>
                        
                        
                        <!-- Compression Level Selector - Renamed to Quality Loss Hint -->
                        <h4 class="text-sm font-medium text-gray-700 pt-2 border-t pt-4">Compression Intensity (Quality Loss Hint):</h4>
                        <div id="compressionLevelSelector" class="grid grid-cols-2 gap-2">
                            <!-- Buttons generated by JS -->
                        </div>
                        <p id="compressionTip" class="text-xs text-gray-500 mt-2 italic">The selected level guides image downscaling aggressiveness when Size is prioritized.</p>
                    </div>
                </div>
            </div>

            <!-- Resolution Reduction (Cropping) Controls -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-full">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">3. Page Cropping (Resolution)</h3>
                    
                    <div class="flex space-x-4 mb-4">
                        <div class="w-1/2">
                            <label for="cropWidth" class="block text-sm font-medium text-gray-700">Output Width (pt)</label>
                            <input
                                type="number"
                                id="cropWidth"
                                value="500"
                                min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2 border"
                            />
                        </div>
                        <div class="w-1/2">
                            <label for="cropHeight" class="block text-sm font-medium text-gray-700">Output Height (pt)</label>
                            <input
                                type="number"
                                id="cropHeight"
                                value="700"
                                min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2 border"
                            />
                        </div>
                    </div>

                    <h4 class="text-sm font-medium text-gray-700 pt-2">Crop Anchor Point:</h4>
                    <div id="cropOriginSelector" class="grid grid-cols-3 gap-2 p-2 bg-gray-100 rounded-lg mt-2">
                        <!-- Origin buttons generated by JS -->
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Content outside the defined width/height will be clipped relative to the anchor point (pt = points, standard PDF unit).</p>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="mt-6 flex justify-center">
            <button 
                id="optimizeBtn"
                disabled
                class="bg-green-600 text-white p-4 rounded-xl font-semibold text-xl shadow-lg hover:bg-green-700 transition duration-150 ease-in-out disabled:opacity-50"
            >
                Optimize PDF & Download
            </button>
        </div>
    </div>

    <script>
        const { PDFDocument, rgb } = PDFLib;

        // UI elements
        const fileInput = document.getElementById('fileInput');
        const optimizeBtn = document.getElementById('optimizeBtn');
        const statusText = document.getElementById('status-text');
        const targetSizeInput = document.getElementById('targetSize');
        const prioritySelector = document.getElementById('prioritySelector');
        const compressionLevelSelector = document.getElementById('compressionLevelSelector');
        const compressionTip = document.getElementById('compressionTip');
        const cropWidthInput = document.getElementById('cropWidth');
        const cropHeightInput = document.getElementById('cropHeight');
        const cropOriginSelector = document.getElementById('cropOriginSelector');
        const newFileSizeSpan = document.getElementById('newFileSize');
        
        // State
        let uploadedFile = null;
        let pdfDoc = null;
        let cropOrigin = 'center'; 
        let compressionLevel = 'medium'; 
        let priorityMode = 'quality'; // 'quality' or 'size'

        const COMPRESSION_LEVELS = {
            'low': { description: 'Minimal effect on quality.', color: 'bg-green-200', text: 'Low', value: 0.9 },
            'medium': { description: 'Moderate quality loss expected.', color: 'bg-yellow-200', text: 'Medium', value: 0.7 },
            'high': { description: 'Significant quality loss likely.', color: 'bg-orange-200', text: 'High', value: 0.5 },
            'extreme': { description: 'Maximum quality loss. Use only if size is critical.', color: 'bg-red-200', text: 'Extreme', value: 0.3 }
        };

        // --- Utility Functions ---

        function updateStatus(message, type = 'info') {
            const statusBox = document.getElementById('status-box');
            statusText.textContent = message;
            statusBox.className = "bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-4 rounded-lg mb-6 shadow"; // Reset class
            
            if (type === 'error') {
                statusBox.className = "bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6 shadow";
            } else if (type === 'success') {
                statusBox.className = "bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg mb-6 shadow";
            }
        }
        
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // --- File Handling ---

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                uploadedFile = null;
                pdfDoc = null;
                optimizeBtn.disabled = true;
                return;
            }

            uploadedFile = file;
            optimizeBtn.disabled = true;
            newFileSizeSpan.textContent = 'N/A';
            updateStatus(`Loading ${file.name}...`);

            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfDoc = await PDFDocument.load(arrayBuffer, { ignoreEncryption: true });

                document.getElementById('fileName').textContent = file.name;
                document.getElementById('pageCount').textContent = pdfDoc.getPageCount();
                document.getElementById('fileSize').textContent = formatBytes(file.size) + ` (${(file.size / 1024).toFixed(0)} KB)`;

                optimizeBtn.disabled = false;
                updateStatus(`PDF loaded successfully. Set your options and click 'Optimize'.`);

            } catch (error) {
                console.error(error);
                updateStatus('Error loading PDF. Ensure it is a valid, non-encrypted PDF file.', 'error');
                uploadedFile = null;
                pdfDoc = null;
            }
        });

        // --- Optimization Logic ---
        
        optimizeBtn.addEventListener('click', async () => {
            if (!pdfDoc) {
                updateStatus('Please upload a PDF first.', 'error');
                return;
            }

            optimizeBtn.disabled = true;
            updateStatus('Optimizing PDF... This may take a moment for large files.', 'info');

            try {
                const targetWidth = parseFloat(cropWidthInput.value);
                const targetHeight = parseFloat(cropHeightInput.value);

                if (targetWidth <= 0 || targetHeight <= 0) {
                     updateStatus('Output width and height must be positive values.', 'error');
                     optimizeBtn.disabled = false;
                     return;
                }
                
                // 1. Apply Page Cropping 
                const pages = pdfDoc.getPages();
                pages.forEach(page => {
                    const { width: pageW, height: pageH } = page.getSize();
                    
                    let cropX = 0;
                    let cropY = 0;
                    
                    const offsetX = pageW - targetWidth;
                    const offsetY = pageH - targetHeight;
                    
                    if (offsetX < 0 || offsetY < 0) {
                        cropX = Math.max(0, -offsetX / 2);
                        cropY = Math.max(0, -offsetY / 2);
                    } else {
                        if (cropOrigin.includes('center')) {
                            cropX = offsetX / 2;
                            cropY = offsetY / 2;
                        } else {
                            if (cropOrigin.includes('right')) cropX = offsetX;
                            if (cropOrigin.includes('bottom')) cropY = offsetY;
                        }
                    }

                    page.setMediaBox(cropX, cropY, targetWidth, targetHeight);
                    page.setCropBox(cropX, cropY, targetWidth, targetHeight);
                });


                // 2. Apply Compression 
                // We use compression only if the priority is set to 'size' or if we are saving the document generally
                // pdf-lib's 'useCompression: true' applies FlateDecode and other stream optimizations.
                
                const useCompression = priorityMode === 'size' || priorityMode === 'quality';

                const arrayBuffer = await pdfDoc.save({
                    useCompression: useCompression,
                });
                
                // 3. Create Blob and Download
                const blob = new Blob([arrayBuffer], { type: 'application/pdf' });
                const blobUrl = URL.createObjectURL(blob);
                const newSizeKB = (blob.size / 1024);
                const targetKB = parseInt(targetSizeInput.value) || 0;

                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = `optimized_${uploadedFile.name}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(blobUrl);
                
                // Update final size display
                newFileSizeSpan.textContent = formatBytes(blob.size) + ` (${newSizeKB.toFixed(0)} KB)`;

                let resultMessage = `Optimization complete! New size: ${newFileSizeSpan.textContent}. File downloaded.`;
                let resultType = 'success';

                if (targetKB > 0) {
                    if (newSizeKB > targetKB) {
                        resultMessage += ` Warning: File size (${newSizeKB.toFixed(0)} KB) is still above your target of ${targetKB} KB.`;
                        if (priorityMode === 'quality') {
                           resultMessage += ` Try switching the priority to 'Size (Override)'.`;
                        }
                        resultType = 'error';
                    } else {
                         resultMessage += ` Success: Target size of ${targetKB} KB was met!`;
                    }
                }

                updateStatus(resultMessage, resultType);
                optimizeBtn.disabled = false;

            } catch (error) {
                console.error("Optimization Error:", error);
                updateStatus('An error occurred during optimization. Check console for details.', 'error');
                optimizeBtn.disabled = false;
            }
        });

        // --- UI Setup ---
        
        // Priority Selector setup
        prioritySelector.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                const newPriority = event.target.dataset.priority;
                
                // Update state
                priorityMode = newPriority;
                
                // Update UI styles
                document.querySelectorAll('#prioritySelector button').forEach(btn => {
                    const isSelected = btn.dataset.priority === newPriority;
                    const baseClass = 'px-3 py-2 rounded-lg font-semibold text-sm transition duration-150 w-full border-2';
                    
                    if (isSelected) {
                        btn.className = `${baseClass} bg-indigo-600 text-white shadow-md border-indigo-700`;
                    } else {
                        btn.className = `${baseClass} bg-gray-200 text-gray-700 hover:bg-gray-300 border-gray-200`;
                    }
                });

                // Update tip based on selection
                const tipElement = document.getElementById('priorityTip');
                if (newPriority === 'size') {
                    tipElement.textContent = "WARNING: Prioritizing size executes the most aggressive compression. Use this when the KB limit is critical, as quality will be noticeably reduced.";
                    tipElement.className = "text-xs text-red-500 mt-2 italic font-bold";
                } else {
                    tipElement.textContent = "Prioritizing quality uses standard compression. The file size may exceed the target, but image and text quality is preserved.";
                    tipElement.className = "text-xs text-gray-500 mt-2 italic";
                }
            }
        });

        // Compression Level Selector setup
        const compressionLevels = Object.keys(COMPRESSION_LEVELS);
        
        const updateCompressionUI = (level) => {
            compressionLevel = level;
            const tip = COMPRESSION_LEVELS[level].description;
            compressionTip.textContent = tip;
            
            document.querySelectorAll('#compressionLevelSelector button').forEach(btn => {
                const btnLevel = btn.dataset.level;
                const baseClass = 'px-3 py-2 rounded-lg font-semibold text-sm transition duration-150 w-full border-2';
                
                if (btnLevel === level) {
                    btn.className = `${baseClass} bg-indigo-600 text-white shadow-md border-indigo-700`;
                } else {
                    btn.className = `${baseClass} bg-gray-200 text-gray-700 hover:bg-gray-300 border-gray-200`;
                }
            });
        };

        compressionLevels.forEach(level => {
            const config = COMPRESSION_LEVELS[level];
            const button = document.createElement('button');
            button.textContent = config.text;
            button.dataset.level = level;
            
            button.addEventListener('click', () => updateCompressionUI(level));
            compressionLevelSelector.appendChild(button);
        });

        // Initialize compression UI to default
        updateCompressionUI(compressionLevel);


        // Crop Origin Selector setup
        const origins = ['top-left', 'top-center', 'top-right', 'center-left', 'center', 'center-right', 'bottom-left', 'bottom-center', 'bottom-right'];
        
        origins.forEach(origin => {
            const button = document.createElement('button');
            
            button.textContent = origin.split('-').map(s => s[0].toUpperCase()).join(''); 
            button.dataset.origin = origin;
            button.className = `p-2 rounded-md text-xs font-medium transition duration-150 border ${origin === cropOrigin ? 'bg-indigo-600 text-white shadow-md border-indigo-700' : 'bg-white text-gray-700 hover:bg-gray-50 border-gray-300'}`;
            button.title = `Crop anchored to ${origin.replace('-', ' ').toUpperCase()}`;

            button.addEventListener('click', () => {
                cropOrigin = origin;
                document.querySelectorAll('#cropOriginSelector button').forEach(btn => {
                    btn.className = btn.dataset.origin === origin ? 'p-2 rounded-md text-xs font-medium transition duration-150 border bg-indigo-600 text-white shadow-md border-indigo-700' : 'p-2 rounded-md text-xs font-medium transition duration-150 border bg-white text-gray-700 hover:bg-gray-50 border-gray-300';
                });
            });

            cropOriginSelector.appendChild(button);
        });

    </script>
</body>
</html>
