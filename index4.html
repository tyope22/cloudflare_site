<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In-Browser PDF Optimizer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load pdf-lib for PDF manipulation -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8">

    <div id="root" class="w-full max-w-5xl mx-auto">
        <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">PDF Compression & Cropping Tool</h1>
        <p class="text-gray-600 mb-8">This tool **Content Scaling** to aggressively reduce file size. Use a lower scale factor for maximum reduction.</p>

        <!-- Status Message -->
        <div id="status-box" class="bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-4 rounded-lg mb-6 shadow">
            <p id="status-text" class="font-medium">Ready: Upload a PDF file to begin optimization.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- File Upload & Information -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-xl h-full flex flex-col justify-start">
                <label for="fileInput" class="block text-lg font-medium text-gray-800 mb-3">1. Upload Source PDF</label>
                <input 
                    type="file" 
                    id="fileInput" 
                    accept="application/pdf" 
                    class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 p-2.5 hover:bg-gray-100 flex-grow"
                />
                
                <!-- Page Range Selector -->
                <div class="mt-4 border-t pt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Process Page Range</h4>
                    <div class="flex space-x-2">
                        <div class="w-1/2">
                            <label for="startPage" class="block text-xs font-medium text-gray-500">Start Page (1-based)</label>
                            <input
                                type="number"
                                id="startPage"
                                value="1"
                                min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                            />
                        </div>
                        <div class="w-1/2">
                            <label for="endPage" class="block text-xs font-medium text-gray-500">End Page</label>
                            <input
                                type="number"
                                id="endPage"
                                value="4"
                                min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                            />
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">If using a large PDF, use a small range (e.g., 1 to 5) to avoid memory issues.</p>
                </div>

                <div id="pdfInfo" class="mt-4 text-sm text-gray-600 space-y-1 border-t pt-4">
                    <p>File: <span id="fileName" class="font-medium">N/A</span></p>
                    <p>Pages: <span id="pageCount" class="font-medium">N/A</span></p>
                    <p>Original Size: <span id="fileSize" class="font-medium">N/A</span></p>
                    <p>New Size: <span id="newFileSize" class="font-medium text-green-700">N/A</span></p>
                </div>
            </div>

            <!-- Size Reduction (Scaling) Controls -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-full">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">2. File Size Reduction (Content Scale)</h3>
                    <div class="space-y-4">
                        
                        <!-- Target Size Input -->
                        <div class="mb-4">
                            <label for="targetSize" class="block text-sm font-medium text-gray-700">Target Max Size (KB)</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input
                                    type="number"
                                    id="targetSize"
                                    value="500"
                                    min="1"
                                    class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                                />
                                <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                                    KB
                                </span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Goal for the final file size.</p>
                        </div>

                        <!-- Content Scale Factor -->
                        <h4 class="text-sm font-medium text-gray-700 pt-2 border-t pt-4">Content Scale Factor: <span id="scaleFactorDisplay" class="font-bold text-indigo-600">0.90</span></h4>
                        <input
                            type="range"
                            id="scaleFactorInput"
                            min="0.1"
                            max="1.0"
                            step="0.05"
                            value="0.9"
                            class="w-full h-2 bg-indigo-100 rounded-lg appearance-none cursor-pointer"
                        />
                        <p id="scaleTip" class="text-xs text-gray-500 mt-2 italic">A smaller scale (e.g., 0.5) aggressively shrinks the page content, offering maximum size reduction.</p>
                    </div>
                </div>
            </div>

            <!-- Resolution Reduction (Cropping) Controls -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-full">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">3. Page Cropping & Positioning</h3>
                    
                    <div class="flex space-x-4 mb-4">
                        <div class="w-1/2">
                            <label for="cropWidth" class="block text-sm font-medium text-gray-700">Output Width (pt)</label>
                            <input
                                type="number"
                                id="cropWidth"
                                value="595"
                                min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2 border"
                            />
                        </div>
                        <div class="w-1/2">
                            <label for="cropHeight" class="block text-sm font-medium text-gray-700">Output Height (pt)</label>
                            <input
                                type="number"
                                id="cropHeight"
                                value="842"
                                min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-2 border"
                            />
                        </div>
                    </div>

                    <h4 class="text-sm font-medium text-gray-700 pt-2">Content Anchor Point:</h4>
                    <div id="cropOriginSelector" class="grid grid-cols-3 gap-2 p-2 bg-gray-100 rounded-lg mt-2">
                        <!-- Origin buttons generated by JS -->
                    </div>
                    <p class="text-xs text-gray-500 mt-2">The default size is A4 (595pt x 842pt). Anchor point determines where the scaled content is placed on the new page.</p>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="mt-6 flex justify-center">
            <button 
                id="optimizeBtn"
                disabled
                class="bg-green-600 text-white p-4 rounded-xl font-semibold text-xl shadow-lg hover:bg-green-700 transition duration-150 ease-in-out disabled:opacity-50"
            >
                Optimize PDF & Download
            </button>
        </div>
    </div>

    <script>
        const { PDFDocument, rgb } = PDFLib;

        // UI elements
        const fileInput = document.getElementById('fileInput');
        const optimizeBtn = document.getElementById('optimizeBtn');
        const statusText = document.getElementById('status-text');
        const scaleFactorInput = document.getElementById('scaleFactorInput');
        const scaleFactorDisplay = document.getElementById('scaleFactorDisplay');
        const cropWidthInput = document.getElementById('cropWidth');
        const cropHeightInput = document.getElementById('cropHeight');
        const cropOriginSelector = document.getElementById('cropOriginSelector');
        const newFileSizeSpan = document.getElementById('newFileSize');
        const startPageInput = document.getElementById('startPage');
        const endPageInput = document.getElementById('endPage');
        
        // State
        let uploadedFile = null;
        let pdfDoc = null;
        let cropOrigin = 'center'; // Default anchor point

        // --- Utility Functions ---

        function updateStatus(message, type = 'info') {
            const statusBox = document.getElementById('status-box');
            statusText.textContent = message;
            statusBox.className = "bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-4 rounded-lg mb-6 shadow"; // Reset class
            
            if (type === 'error') {
                statusBox.className = "bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6 shadow";
            } else if (type === 'success') {
                statusBox.className = "bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg mb-6 shadow";
            }
        }
        
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        /**
         * Calculates the x and y coordinates to draw the scaled content, based on the anchor point.
         */
        function calculateDrawPosition(origin, targetWidth, targetHeight, scaledW, scaledH) {
            let x, y;
            const xOffset = targetWidth - scaledW;
            const yOffset = targetHeight - scaledH;

            // X Position calculation
            if (origin.includes('left')) {
                x = 0;
            } else if (origin.includes('right')) {
                x = xOffset;
            } else { // center
                x = xOffset / 2;
            }

            // Y Position calculation (PDF Y-axis starts at bottom)
            if (origin.includes('bottom')) {
                y = 0;
            } else if (origin.includes('top')) {
                y = yOffset;
            } else { // center
                y = yOffset / 2;
            }

            return { x, y };
        }

        // --- File Handling ---

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                uploadedFile = null;
                pdfDoc = null;
                optimizeBtn.disabled = true;
                return;
            }

            uploadedFile = file;
            optimizeBtn.disabled = true;
            newFileSizeSpan.textContent = 'N/A';
            updateStatus(`Loading ${file.name}...`);

            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfDoc = await PDFDocument.load(arrayBuffer, { ignoreEncryption: true });

                document.getElementById('fileName').textContent = file.name;
                const pageCount = pdfDoc.getPageCount();
                document.getElementById('pageCount').textContent = pageCount;
                document.getElementById('fileSize').textContent = formatBytes(file.size) + ` (${(file.size / 1024).toFixed(0)} KB)`;
                
                // Set default crop size to the first page's size for a better starting point
                if (pageCount > 0) {
                    const firstPage = pdfDoc.getPages()[0];
                    const { width, height } = firstPage.getSize();
                    cropWidthInput.value = Math.round(width);
                    cropHeightInput.value = Math.round(height);
                }
                
                // Update page range inputs
                startPageInput.value = 1;
                endPageInput.value = pageCount;


                optimizeBtn.disabled = false;
                updateStatus(`PDF loaded successfully (${pageCount} pages). Set your options and click 'Optimize'.`);

            } catch (error) {
                console.error(error);
                updateStatus('Error loading PDF. Ensure it is a valid, non-encrypted PDF file.', 'error');
                uploadedFile = null;
                pdfDoc = null;
            }
        });

        // --- Optimization Logic (New Strategy: Embed and Draw) ---
        
        optimizeBtn.addEventListener('click', async () => {
            if (!pdfDoc) {
                updateStatus('Please upload a PDF first.', 'error');
                return;
            }

            optimizeBtn.disabled = true;
            updateStatus('Aggressively optimizing PDF by scaling content...', 'info');

            try {
                const targetWidth = parseFloat(cropWidthInput.value);
                const targetHeight = parseFloat(cropHeightInput.value);
                const scaleFactor = parseFloat(scaleFactorInput.value);
                
                if (targetWidth <= 0 || targetHeight <= 0) {
                     updateStatus('Output width and height must be positive values.', 'error');
                     optimizeBtn.disabled = false;
                     return;
                }

                // --- 1. Determine Page Indices to Process ---
                const totalPages = pdfDoc.getPageCount();
                let startPage = parseInt(startPageInput.value) || 1;
                let endPage = parseInt(endPageInput.value) || totalPages;
                
                // Clamp pages to valid range
                if (startPage < 1) startPage = 1;
                if (endPage > totalPages) endPage = totalPages;
                if (startPage > endPage) startPage = endPage; 

                // 0-based index range
                const startIndex = startPage - 1;
                const endIndex = endPage; // exclusive for slice
                
                if (startIndex >= endIndex) {
                    updateStatus('Page range is invalid. Please check start and end page numbers.', 'error');
                    optimizeBtn.disabled = false;
                    return;
                }

                const pagesToProcess = endIndex - startIndex;
                updateStatus(`Starting optimization for pages ${startPage} to ${endPage} (${pagesToProcess} total pages)...`, 'info');

                // --- 2. Create New Document and get pages from old doc ---
                const newPdfDoc = await PDFDocument.create();
                
                // Get the subset of pages to process from the original document
                const sourcePages = pdfDoc.getPages().slice(startIndex, endIndex);

                for (let i = 0; i < sourcePages.length; i++) {
                    const originalPage = sourcePages[i];
                    const pageNumber = startPage + i; // 1-based page number for status message
                    
                    try {
                        updateStatus(`Processing page ${pageNumber} of ${endPage} (Total pages in job: ${pagesToProcess})...`, 'info');
                        
                        // 3. Embed the original page content as a Form Object (XObject)
                        // This is the key step: it ensures the content is transferred robustly.
                        const [embeddedPage] = await newPdfDoc.embedPages([originalPage]);
                        
                        // 4. Add a new page with the user's desired output dimensions (This is the blank canvas)
                        const newPage = newPdfDoc.addPage([targetWidth, targetHeight]);

                        // 5. Calculate scaled content size
                        const { width: pageW, height: pageH } = embeddedPage.size;
                        const scaledW = pageW * scaleFactor;
                        const scaledH = pageH * scaleFactor;
                        
                        // 6. Calculate position based on the selected anchor point
                        const { x: drawX, y: drawY } = calculateDrawPosition(
                            cropOrigin, targetWidth, targetHeight, scaledW, scaledH
                        );

                        // 7. Draw the embedded content onto the new page (the canvas)
                        newPage.drawPage(embeddedPage, {
                            x: drawX,
                            y: drawY,
                            width: scaledW,
                            height: scaledH,
                        });
                        
                        // 8. Visual Debugging: Draw a small red square in the top-left to prove the newPage is active.
                        newPage.drawRectangle({
                            x: 5, y: targetHeight - 15, width: 10, height: 10,
                            color: rgb(1, 0, 0),
                        });
                        
                        // 9. Ensure the final visible area is set correctly
                        newPage.setMediaBox(0, 0, targetWidth, targetHeight); 
                        newPage.setCropBox(0, 0, targetWidth, targetHeight);
                        
                        // Since newPdfDoc.embedPages implicitly adds the content,
                        // we must remove the page that was created by embedPages (the page before the last one).
                        // This part is the tricky bit, but is required by the embedPages process when used iteratively.
                        // The embeddedPage object remains valid even if its corresponding page is removed.
                        newPdfDoc.removePage(newPdfDoc.getPageCount() - 2); 


                    } catch (pageError) {
                        console.error(`ERROR: Failed to process page ${pageNumber}. The page content may be corrupted or too complex.`, pageError);
                        
                        // If an error happened, remove the page added by addPage (the last page).
                        if (newPdfDoc.getPageCount() > 0) {
                            newPdfDoc.removePage(newPdfDoc.getPageCount() - 1); 
                        }
                       
                        updateStatus(`Warning: Failed to process page ${pageNumber}. Skipping page due to content error. Check CONSOLE for full details.`, 'error');
                    }
                }

                // --- 10. Finalize and Download ---
                const arrayBuffer = await newPdfDoc.save({ useCompression: true });
                
                const blob = new Blob([arrayBuffer], { type: 'application/pdf' });
                const blobUrl = URL.createObjectURL(blob);
                const newSizeKB = (blob.size / 1024);

                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = `optimized_${startPage}_to_${endPage}_${uploadedFile.name}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(blobUrl);
                
                // Update final size display
                newFileSizeSpan.textContent = formatBytes(blob.size) + ` (${newSizeKB.toFixed(0)} KB)`;

                let resultMessage = `Optimization complete! ${newPdfDoc.getPageCount()} pages successfully created. New size: ${newFileSizeSpan.textContent}. File downloaded.`;
                updateStatus(resultMessage, 'success');
                optimizeBtn.disabled = false;

            } catch (error) {
                console.error("Optimization Fatal Error:", error);
                // If a fatal error occurs, the source is likely complex content the library can't handle.
                updateStatus('A fatal optimization error occurred. The PDF content is likely too complex for in-browser manipulation. Please try a different source file or check the browser console for details.', 'error');
                optimizeBtn.disabled = false;
            }
        });

        // --- UI Setup ---
        
        // Scale Factor Slider listener
        scaleFactorInput.addEventListener('input', () => {
            const value = parseFloat(scaleFactorInput.value).toFixed(2); 
            scaleFactorDisplay.textContent = value;
        });

        // Crop Origin Selector setup
        const origins = ['top-left', 'top-center', 'top-right', 'center-left', 'center', 'center-right', 'bottom-left', 'bottom-center', 'bottom-right'];
        
        origins.forEach(origin => {
            const button = document.createElement('button');
            
            button.textContent = origin.split('-').map(s => s[0].toUpperCase()).join(''); 
            button.dataset.origin = origin;
            button.className = `p-2 rounded-md text-xs font-medium transition duration-150 border ${origin === cropOrigin ? 'bg-indigo-600 text-white shadow-md border-indigo-700' : 'bg-white text-gray-700 hover:bg-gray-50 border-gray-300'}`;
            button.title = `Content anchored to ${origin.replace('-', ' ').toUpperCase()}`;

            button.addEventListener('click', () => {
                cropOrigin = origin;
                document.querySelectorAll('#cropOriginSelector button').forEach(btn => {
                    btn.className = btn.dataset.origin === origin ? 'p-2 rounded-md text-xs font-medium transition duration-150 border bg-indigo-600 text-white shadow-md border-indigo-700' : 'p-2 rounded-md text-xs font-medium transition duration-150 border bg-white text-gray-700 hover:bg-gray-50 border-gray-300';
                });
                updateStatus(`Content anchor set to ${origin}.`);
            });

            cropOriginSelector.appendChild(button);
        });

    </script>
</body>
</html>
